name: DevOps CI Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:

  build:
    name: Build Application
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: Build
        run: echo "Building application..."

  test:
    name: Run Tests
    runs-on: self-hosted
    needs: build
    steps:
      - uses: actions/checkout@v3
      - name: Run unit tests
        run: echo "Running tests..."

  lint:
    name: Lint Check
    runs-on: self-hosted
    needs: test
    steps:
      - uses: actions/checkout@v3
      - name: Run lint
        run: echo "Running lint..."

  build_image:
    name: Build Docker Image
    runs-on: self-hosted
    needs: lint
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker image
        run: |
          docker build -t myapp:${{ github.sha }} .

  push_image:
    name: Push Docker Image
    runs-on: self-hosted
    needs: build_image
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Push image
        run: |
          docker tag myapp:${{ github.sha }} myapp:release-${{ github.run_number }}
          echo "Pushing image..."

  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: push_image
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    steps:
      - name: Deploy
        run: echo "Deploying to production..."
